/*! oauth2_security - v1.0.0 - 2015-10-08 */angular.module("oauth2.security",[]).factory("Principle",["$cookieStore",function(a){var b,c,d="PRINCIPLE_KEY",e="USER_KEY",f=function(){c=c?c:a.get(e),b=b?b:a.get(d)};return{isAvailabel:function(){return f(),Boolean(b)},getPrinciple:function(){return f(),b},getAccessToken:function(){return f(),b?b.access_token:null},getRefreshToken:function(){return f(),b?b.refresh_token:null},getUser:function(){return f(),c},setUser:function(b){c=b,a.put(e,b)},setPrinciple:function(c){b=c,a.put(d,c)},clear:function(){a.remove(d),a.remove(e),c=null,b=null}}}]).factory("OAuthProcessor",["$http",function(a){return{accessToken:function(b){return a({method:"POST",url:b.url.baseUrl+b.url.login,data:$.param({client_id:b.client.clientId,client_secret:b.client.clientSecret,grant_type:b.client.passwordGrantType,scop:b.client.scop,username:b.username,password:b.password}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(a){return a.data})},refreshToken:function(b){return a({method:"POST",url:b.url.baseUrl+b.url.login,data:$.param({client_id:b.client.clientId,client_secret:b.client.clientSecret,grant_type:b.client.refreshTokeGrantType,refresh_token:b.refresh_token}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(a){return console.log("accessToken Refreshed===",a.data),a.data})},revokeToken:function(b){return a({method:"GET",url:b.url.baseUrl+b.url.api+b.url.version+b.url.logout})},me:function(b){return a.get(b.url.baseUrl+b.url.api+b.url.version+b.url.user).then(function(a){return a.data})}}}]).factory("AuthInterceptor",["$q","Principle","$injector",function(a,b,c){var d=null;return{request:function(a){var d=c.get("OAuth");return a.url.match(d.getConfigByUser(b.getUser()).apiPattern)&&(a.headers=a.headers||{},b.isAvailabel()&&(a.headers.Authorization="Bearer "+b.getAccessToken(),a.headers.Accept="*")),a},responseError:function(e){var f=c.get("OAuthProcessor");if(b.getPrinciple())switch(e.status){case 401:var g=c.get("OAuth"),h=a.defer();if(!d){var i=angular.extend(b.getPrinciple(),g.getApiConfig());d=f.refreshToken(i)}return d.then(function(a){d=null,a.access_token?(b.setPrinciple(a),c.get("$http")(e.config).then(function(a){h.resolve(a)},function(a){h.reject(a)})):h.reject(e)},function(a){return d=null,h.reject(),b.clear(),g.redirectCurrentUserPage(),a}),h.promise}return a.reject(e)}}}]).provider("OAuth",["$httpProvider",function(a){function b(a){d=a,e=a.http}function c(a,b,c,f){var g=this;return this.getConfigByUser=function(a){var b=null;return e.forEach(function(c){return a&&a.roles?c.role==a.roles[0]?(b=c,!0):!1:"ROOT"==c.role?(b=c,!0):!1}),b},this.redirectCurrentUserPage=function(){var d=c.defer();return b.location.pathname.match("/"+g.getConfigByUser(a.getUser()).appPath)?d.resolve():b.location.href=g.getConfigByUser(a.getUser()).appPath,d.promise},this.login=function(b){return angular.extend(b,d),f.accessToken(b).then(function(c){return a.setPrinciple(c),f.me(b).then(function(b){return a.setUser(b),g.redirectCurrentUserPage(),b})})},this.logout=function(){return f.revokeToken(d).then(function(){a.clear(),g.redirectCurrentUserPage()},function(){a.clear(),g.redirectCurrentUserPage()})},this.getApiConfig=function(){return d},this.getAbsUrl=function(a){return d.url.baseUrl+d.url.api+d.url.version+a},this.getAbsUrlWithAuth=function(b){return b=b.indexOf("?")>1?b+"&access_token="+a.getAccessToken():b+"?access_token="+a.getAccessToken(),d.url.baseUrl+d.url.api+d.url.version+b},this.getUrlWithAuth=function(b){return b=b.indexOf("?")>1?b+"&access_token="+a.getAccessToken():b+"?access_token="+a.getAccessToken()},this}var d,e;return a.interceptors.push("AuthInterceptor"),{config:b,$get:["Principle","$window","$q","OAuthProcessor",c]}}]).directive("logoutLink",["OAuth",function(a){return{restrict:"AE",replace:!0,template:'<a href="">Sign out</a>',link:function(b,c,d){c.on("click",function(b){a.logout()})}}}]).directive("currentUserName",["Principle",function(a){return{restrict:"AE",template:"{{currentUserName}}",link:function(b,c,d){b.currentUserName=a.getUser().name}}}]).directive("currentUserImage",["Principle",function(a){return{restrict:"E",replace:!0,template:'<img oauth-ng-img="imageUrl" dimg="user">',controller:["$scope",function(b){b.imageUrl=a.getUser()._links.image?a.getUser()._links.image.href:"",b.$on("PROFILE_PICTURE_UPDATED_EVENT",function(c,d){b.imageUrl=d+"?"+Math.random();var e=a.getUser();e._links.image={href:d},a.setUser(e)})}]}}]).directive("currentUserEmail",["Principle",function(a){return{restrict:"AE",template:"{{currentUserEmail}}",link:function(b,c,d){b.currentUserEmail=a.getUser().email}}}]).directive("oauthNgImg",["OAuth",function(a){return{restrict:"A",link:function(b,c,d){var e=d.oauthNgImg,f="assets/img/no-image-icon.png";"user"==d.dimg&&(f="assets/img/avatars/user_profile.jpg"),c.on("error",function(a){c.attr("src",f)}),c.attr("src",a.getUrlWithAuth(e)),b.$watch(d.oauthNgImg,function(b){b&&c.attr("src",a.getUrlWithAuth(b))})}}}]);