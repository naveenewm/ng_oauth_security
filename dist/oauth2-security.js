/* oauth2-security - v1.1.0 - 2016-03-29 
 * Copyright (c) 2016  Naveen Raj 
 *  License: MIT 
 */ 
angular.module("oauth2.security",["ngCookies"]).provider("OAuthConfig",[function(){function a(a){var d,e;return e=new function(b){this.loginPage=b.loginPage,this.intercept=b.intercept,this.targetUrl=b.targetUrl,this.targetUrlProvider=b.targetUrlProvider,this.deniedPageUrl=b.deniedPageUrl,this.deniedUrlProvider=b.deniedUrlProvider,this.getLoginPageUrl=function(){return this.loginPage||"#/login"},this.getAccessDeniedPageUrl=function(){return this.deniedPageUrl||this.deniedUrlProvider&&a.invoke(this.deniedUrlProvider)||"#/access-denied"},this.getTargetUrl=function(){return this.targetUrl||this.targetUrlProvider&&a.invoke(this.targetUrlProvider)||"#/home"}}(b.view),d=new function(a){this.intercept=a.intercept?a.intercept:[],a.secureApiUrlPatterns&&this.intercept.push({urlPatterns:a.secureApiUrlPatterns,headers:{Authorization:"Bearer {{access_token}}"}}),this.urlResolver="function"==typeof a.urlResolver?a.urlResolver(c):a.urlResolver,this.addIntercept=function(a){this.intercept=this.intercept||[],this.intercept.push(a)},this.getUrlResolver=function(){return this.urlResolver}}(b.http),{getContext:function(){return c},getView:function(){return e},getRefreshTokeGrandType:function(){return b.refreshTokeGrandType},getEntryPoint:function(){if(!b.entryPoint)throw new Error("entryPoint config not found");return b.entryPoint},getHttp:function(){return d}}}var b,c,d;return{setConfig:function(a){if(b=a,d=a.grandType,c=a.context||{},!a.http)throw new Error("http config not found");if(!a.view)throw new Error("view config not found");if(!a.entryPoint)throw new Error("oauth type config not found")},$get:["$injector",a]}}]).factory("ExpResolver",["OAuthConfig",function(a){function b(a){if(a)for(var b in d){var c=d[b];a=a.replace(new RegExp("{{"+b+"}}|\\${"+b+"}","g"),"function"==typeof c?c():c)}return a}var c=a.getHttp().getUrlResolver(),d={};for(var e in c.map)d[e]=c.map[e];return{appMap:function(a,b){a&&b&&(d[a]=b)},removeMap:function(a){a&&delete d[a]},resolve:function(a){return c&&b(a)||a},resolveUrl:function(a){return c&&b(a)||a}}}]).factory("Principle",["$cookieStore","$rootScope",function(a,b){var c,d,e,f="PRINCIPLE_OAUTH",g="USER_OAUTH",h="AUTHORITIES_OAUTH",i=function(b,i,j){b?(c=b,a.put(f,c)):c=c||a.get(f),i?(d=i,a.put(g,d)):d=d||a.get(g),j?(e=j,a.put(h,e)):e=e||a.get(h)},j=function(){a.remove(f),a.remove(g),a.remove(h),c=d=e=null};return{isAvailabel:function(){return i(),!!c},credentials:function(a){if(i(a),c)return c;throw new Error("principle not found")},user:function(a,b){if(i(void 0,a,b),d)return d;throw new Error("user not found")},authorities:function(a){if(i(void 0,void 0,a),e)return e;throw new Error("authorities not found")},getAccessToken:function(){return this.credentials().access_token},getRefreshToken:function(){return this.credentials().refresh_token},setAuthentications:function(a,b,c){if(!(a&&b&&c))throw new Error("principle not persisted",a,b,c);i(a,b,c)},clear:j}}]).factory("OAuthProcessor",["$http","OAuthConfig","$injector","$log","$httpParamSerializerJQLike",function(a,b,c,d,e){var f=b.getContext(),g=null;try{g=c.invoke(b.getEntryPoint())}catch(h){d.debug(h)}var i=new function(){this.accessToken=function(b,c,d){var g=angular.extend({method:"POST",url:"${authServer}/${login}"},b);return g.data=angular.extend({client_id:f.client.clientId,client_secret:f.client.clientSecret,username:c,password:d,grant_type:"password",scope:"read"},b.data),g.headers=angular.extend({"Content-Type":"application/x-www-form-urlencoded"},b.headers),g.data=g.data&&"application/x-www-form-urlencoded"==g.headers["Content-Type"]?e(g.data):g.data,a(g).then(function(a){return a.data})},this.refreshToken=function(b,c){var d=angular.extend({method:"POST",url:"${authServer}/${login}"},b);return d.data=angular.extend({client_id:f.client.clientId,client_secret:f.client.clientSecret,grant_type:"refresh_token",refresh_token:c},b.data),d.headers=angular.extend({"Content-Type":"application/x-www-form-urlencoded"},b.headers),d.data=d.data&&"application/x-www-form-urlencoded"==d.headers["Content-Type"]?e(d.data):d.data,a(d).then(function(a){return a.data})},this.revokeToken=function(b){var c=angular.extend({method:"POST",url:"${authServer}/${revoke}"},b);return c.data=angular.extend({},b.data),c.headers=angular.extend({"Content-Type":"application/x-www-form-urlencoded"},b.headers),c.data=c.data&&"application/x-www-form-urlencoded"==c.headers["Content-Type"]?e(c.data):c.data,a(c)},this.me=function(b){var c=angular.extend({method:"GET",url:"${resourceServer}/${me}"},b);return c.data=angular.extend({},b.data),c.headers=angular.extend({"Content-Type":"application/x-www-form-urlencoded"},b.headers),c.data=c.data&&"application/x-www-form-urlencoded"==c.headers["Content-Type"]?e(c.data):c.data,a(c).then(function(a){return a.data})},this.extractRoles=function(a){return a.roles||["ROLE_USER"]}};return{accessToken:function(a,b){return g&&"function"==typeof g.accessToken?g.accessToken(a,b):i.accessToken(g.accessToken,a,b)},refreshToken:function(a){return g&&"function"==typeof g.refreshToken?g.refreshToken(a):i.refreshToken(g.refreshToken,a)},revokeToken:function(){return g&&"function"==typeof g.revokeToken?g.revokeToken():i.revokeToken(g.revokeToken)},me:function(){return g&&"function"==typeof g.me?g.me():i.me(g.me)},extractRoles:function(a){return(g&&"function"==typeof g.extractRoles&&g.extractRoles||i.extractRoles)(a)}}}]).factory("AuthInterceptor",["OAuthConfig","$q","Principle","$injector","$log","ExpResolver",function(a,b,c,d,e,f){var g=null,h=d.get("OAuthConfig").getHttp();return f.appMap("access_token",function(){try{return c.getAccessToken()}catch(a){}}),{request:function(a){if(a.url=f.resolveUrl(a.url),h.intercept&&h.intercept.length)for(var b in h.intercept){var c=h.intercept[b];for(var b in c.urlPatterns)if(c.urlPatterns[b].test(a.url)){for(var d in c.headers)a.headers[d]=f.resolve(c.headers[d]);for(var d in c.params)a.params[d]=f.resolve(c.params[d])}}return a},responseError:function(e){switch(e.status){case 401:if(c.isAvailabel()&&a.getRefreshTokeGrandType()){var f=d.get("OAuthProcessor"),h=(d.get("OAuth"),b.defer());return g||(g=f.refreshToken(c.getRefreshToken())),g.then(function(a){g=null,a.access_token?(c.credentials(a),d.get("$http")(e.config).then(function(a){h.resolve(a)},function(a){h.reject(a)})):h.reject(e)},function(a){return g=null,h.reject(),c.clear(),d.get("Redirection").confirmAccess(),a}),h.promise}}return b.reject(e)}}}]).factory("Redirection",["$window","$location","OAuthConfig","Principle","$log","$rootScope",function(a,b,c,d,e,f){var g=new function(){var g=c.getView(),h=function(c){e.debug("redirecting - ",c);var d=document.createElement("a");d.href=c,d.host==a.location.host&&d.pathname==a.location.pathname||(a.location.href=c),b.url(d.hash.substr(1,d.hash.length))},i=function(a){a=a?a:b.absUrl();var c=[];for(var d in g.intercept){var e=g.intercept[d];e.urlPattern.test(a)&&(c=c.concat(e.roles))}return c};this.confirmAccess=function(){var a=b.absUrl(),c=null;try{c=d.authorities(),c.push("IS_AUTHENTICATED_ANONYMOUSLY")}catch(j){e.error(j.message),c=["IS_ANONYMOUSLY"]}i(a).some(function(a){return c.indexOf(a)>=0})?(e.debug("page authenticated",a),f.$broadcast("oauth2:page-authenticated",a)):(h(c.indexOf("IS_ANONYMOUSLY")<0?g.getAccessDeniedPageUrl():g.getLoginPageUrl()),e.debug("page denied",a),f.$broadcast("oauth2:page-denied",a))},this.redirectToTarget=function(){h(g.getTargetUrl())}};return g}]).run(["$rootScope","Redirection",function(a,b){a.$on("$locationChangeStart",function(a,c,d){b.confirmAccess()})}]).provider("OAuth",["$httpProvider","OAuthConfigProvider",function(a,b){function c(a){b.setConfig(a)}function d(a,b,c,d,e){var f=a.getContext();return this.getContext=function(){return f},this.login=function(a,f,g){return d.accessToken(a,f).then(function(a){return b.credentials(a),d.me().then(function(a){return b.user(a,d.extractRoles(a)),g&&c.redirectToTarget(),a},function(a){e.$broadcast("oauth2:user-obtaining-failure",a)})},function(a){e.$broadcast("oauth2:credentials-obtaining-failure",a)})},this.logout=function(){return d.revokeToken().then(function(a){b.clear(),c.confirmAccess(),e.$broadcast("oauth2:revoke-success",a.data)},function(a){b.clear(),c.confirmAccess(),e.$broadcast("oauth2:revoke-failure",a)})},this.getAbsUrl=function(a){return f.url.resourceServer+a},this.getAbsUrlWithAuth=function(a){return a=a.indexOf("?")>1?a+"&access_token="+b.getAccessToken():a+"?access_token="+b.getAccessToken(),f.url.resourceServer+a},this.getUrlWithAuth=function(a){return a=a.indexOf("?")>1?a+"&access_token="+b.getAccessToken():a+"?access_token="+b.getAccessToken()},this}return a.interceptors.push("AuthInterceptor"),{config:c,$get:["OAuthConfig","Principle","Redirection","OAuthProcessor","$rootScope",d]}}]).directive("oauthSrc",["ExpResolver",function(a){function b(a,b){var c=new Image;c.src=a,angular.element(c).bind("load",function(){b.attr("src",a)})}return{restrict:"A",link:function(c,d,e){var f=e.defaultSrc?e.defaultSrc:"assets/img/no-image-icon.png";d.on("error",function(a){b(f,d)}),e.$observe("oauthSrc",function(c,e){void 0!=c&&(c+=c.indexOf("?")>1?"&access_token=${access_token}":"?access_token=${access_token}",b(a.resolveUrl(c),d))})}}}]);